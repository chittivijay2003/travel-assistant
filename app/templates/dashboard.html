<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Assistant Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #999;
            margin-top: 5px;
        }
        
        .scenario-comparison {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .scenario-comparison h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .scenario-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        
        .scenario-card.optimized {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }
        
        .scenario-card h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .scenario-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .scenario-metric strong {
            color: #555;
        }
        
        .scenario-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .savings-highlight {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .savings-highlight h3 {
            color: #28a745;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .savings-value {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .chart-card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #333;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .table-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .table-card h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #333;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #dee2e6;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Travel Assistant Analytics</h1>
            <p>Real-time performance metrics and insights</p>
        </header>
        
        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading metrics...</div>
        </div>
        
        <div class="scenario-comparison" id="scenarioComparison" style="display: none;">
            <h2>üéØ Token Optimization: Scenario Comparison</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Comparing token usage across different few-shot example strategies
            </p>
            <div class="scenarios-grid">
                <div class="scenario-card">
                    <h3>üìù Scenario 1: No History</h3>
                    <div class="scenario-metric">
                        <strong>Input Tokens:</strong>
                        <span id="s1-input">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Output Tokens:</strong>
                        <span id="s1-output">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Total Tokens:</strong>
                        <span id="s1-total">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Cost Estimate:</strong>
                        <span id="s1-cost">-</span>
                    </div>
                </div>
                
                <div class="scenario-card">
                    <h3>üìö Scenario 2: All History (Naive)</h3>
                    <div class="scenario-metric">
                        <strong>Input Tokens:</strong>
                        <span id="s2-input">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Output Tokens:</strong>
                        <span id="s2-output">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Total Tokens:</strong>
                        <span id="s2-total">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Cost Estimate:</strong>
                        <span id="s2-cost">-</span>
                    </div>
                </div>
                
                <div class="scenario-card optimized">
                    <span class="scenario-badge">‚ú® ACTIVE</span>
                    <h3>üéØ Scenario 3: Smart Optimized</h3>
                    <div class="scenario-metric">
                        <strong>Input Tokens:</strong>
                        <span id="s3-input">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Output Tokens:</strong>
                        <span id="s3-output">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Total Tokens:</strong>
                        <span id="s3-total">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Cost Estimate:</strong>
                        <span id="s3-cost">-</span>
                    </div>
                    <div class="scenario-metric">
                        <strong>Cache Hit:</strong>
                        <span id="s3-cache-hit">-</span>
                    </div>
                    <div id="s3-ranking-details" style="display: none; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong style="display: block; margin-bottom: 8px; color: #667eea;">üìä Example Ranking Info:</strong>
                        <div id="s3-ranking-content" style="font-size: 0.9em; color: #666;"></div>
                    </div>
                </div>
            </div>
            
            <div class="savings-highlight">
                <h3>üí∞ Optimization Savings</h3>
                <div class="savings-value" id="savings-percentage">-</div>
                <p style="color: #666; margin-top: 10px;">
                    <span id="tokens-saved">-</span> tokens saved vs. naive approach
                </p>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h2>Hourly Request Volume</h2>
                <div class="chart-container">
                    <canvas id="requestsChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>Token Usage Over Time</h2>
                <div class="chart-container">
                    <canvas id="tokensChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>Average Latency</h2>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>Endpoint Distribution</h2>
                <div class="chart-container">
                    <canvas id="endpointChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-card">
            <h2>Top Users</h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Requests</th>
                        <th>Total Tokens</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="table-card">
            <h2>Endpoint Statistics</h2>
            <table id="endpointsTable">
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Requests</th>
                        <th>Avg Latency (ms)</th>
                        <th>Error Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh</button>
    
    <script>
        let charts = {};
        
        async function loadDashboard() {
            try {
                const response = await fetch('/dashboard/api/metrics');
                const data = await response.json();
                
                updateStats(data);
                updateCharts(data);
                updateTables(data);
                
                // Load scenario comparison data
                await loadScenarioComparison();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        async function loadScenarioComparison() {
            try {
                const response = await fetch('/dashboard/api/scenarios/latest');
                const data = await response.json();
                
                if (data.has_data) {
                    document.getElementById('scenarioComparison').style.display = 'block';
                    
                    const s1 = data.scenario_1_no_history;
                    const s2 = data.scenario_2_all_history;
                    const s3 = data.scenario_3_smart_history;
                    
                    // Scenario 1
                    document.getElementById('s1-input').textContent = s1.input_tokens.toLocaleString();
                    document.getElementById('s1-output').textContent = s1.output_tokens.toLocaleString();
                    document.getElementById('s1-total').textContent = s1.total_tokens.toLocaleString();
                    document.getElementById('s1-cost').textContent = '$' + s1.cost_estimate.toFixed(6);
                    
                    // Scenario 2
                    document.getElementById('s2-input').textContent = s2.input_tokens.toLocaleString();
                    document.getElementById('s2-output').textContent = s2.output_tokens.toLocaleString();
                    document.getElementById('s2-total').textContent = s2.total_tokens.toLocaleString();
                    document.getElementById('s2-cost').textContent = '$' + s2.cost_estimate.toFixed(6);
                    
                    // Scenario 3
                    document.getElementById('s3-input').textContent = s3.input_tokens.toLocaleString();
                    document.getElementById('s3-output').textContent = s3.output_tokens.toLocaleString();
                    document.getElementById('s3-total').textContent = s3.total_tokens.toLocaleString();
                    document.getElementById('s3-cost').textContent = '$' + s3.cost_estimate.toFixed(6);
                    
                    // Cache hit and ranking info
                    const cacheHit = s3.cache_hit || false;
                    document.getElementById('s3-cache-hit').textContent = cacheHit ? '‚úÖ Yes' : '‚ùå No';
                    
                    // Display ranking info if available
                    if (s3.ranking_info) {
                        const rankingDiv = document.getElementById('s3-ranking-details');
                        const rankingContent = document.getElementById('s3-ranking-content');
                        
                        let html = '';
                        for (const [component, data] of Object.entries(s3.ranking_info)) {
                            if (data && data.ranking_info) {
                                const info = data.ranking_info;
                                html += `<div style="margin-bottom: 8px;"><strong>${component.charAt(0).toUpperCase() + component.slice(1)}:</strong> `;
                                html += `${info.top_examples_selected || 0} examples `;
                                if (info.ranking_weights) {
                                    html += `(${Math.round(info.ranking_weights.satisfaction * 100)}% satisfaction, `;
                                    html += `${Math.round(info.ranking_weights.popularity * 100)}% popularity, `;
                                    html += `${Math.round(info.ranking_weights.recency * 100)}% recency)`;
                                }
                                html += `</div>`;
                            }
                        }
                        
                        if (html) {
                            rankingContent.innerHTML = html;
                            rankingDiv.style.display = 'block';
                        }
                    }
                    
                    // Savings
                    document.getElementById('savings-percentage').textContent = data.savings_percentage.toFixed(1) + '%';
                    document.getElementById('tokens-saved').textContent = data.tokens_saved.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading scenario comparison:', error);
            }
        }
        
        function updateStats(data) {
            const statsGrid = document.getElementById('statsGrid');
            const summary = data.summary_24h;
            const overall = data.overall;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Requests (24h)</h3>
                    <div class="stat-value">${summary.total_requests.toLocaleString()}</div>
                    <div class="stat-label">API calls in last 24 hours</div>
                </div>
                <div class="stat-card">
                    <h3>Success Rate</h3>
                    <div class="stat-value">${(summary.success_rate * 100).toFixed(1)}%</div>
                    <div class="stat-label">${summary.error_count} errors</div>
                </div>
                <div class="stat-card">
                    <h3>Total Tokens (24h)</h3>
                    <div class="stat-value">${summary.total_tokens.toLocaleString()}</div>
                    <div class="stat-label">Avg: ${Math.round(summary.avg_tokens_per_request)} per request</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Latency</h3>
                    <div class="stat-value">${Math.round(summary.avg_latency_ms)}ms</div>
                    <div class="stat-label">Response time</div>
                </div>
                <div class="stat-card">
                    <h3>Total Requests (All Time)</h3>
                    <div class="stat-value">${overall.total_requests.toLocaleString()}</div>
                    <div class="stat-label">Since tracking started</div>
                </div>
                <div class="stat-card">
                    <h3>Total Tokens (All Time)</h3>
                    <div class="stat-value">${overall.total_tokens.toLocaleString()}</div>
                    <div class="stat-label">Cumulative usage</div>
                </div>
            `;
        }
        
        function updateCharts(data) {
            // Hourly requests chart
            updateLineChart('requestsChart', 'Requests', data.hourly_breakdown, 
                           item => item.requests, 'rgba(102, 126, 234, 0.8)');
            
            // Token usage chart
            updateLineChart('tokensChart', 'Tokens', data.hourly_breakdown,
                           item => item.tokens, 'rgba(118, 75, 162, 0.8)');
            
            // Latency chart
            updateLineChart('latencyChart', 'Latency (ms)', data.hourly_breakdown,
                           item => Math.round(item.avg_latency_ms), 'rgba(255, 99, 132, 0.8)');
            
            // Endpoint distribution (pie chart)
            updatePieChart('endpointChart', data.endpoint_stats);
        }
        
        function updateLineChart(canvasId, label, data, valueFunc, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.hour.split('_')[1] + ':00'),
                    datasets: [{
                        label: label,
                        data: data.map(valueFunc),
                        borderColor: color,
                        backgroundColor: color.replace('0.8', '0.2'),
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updatePieChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            const colors = [
                'rgba(102, 126, 234, 0.8)',
                'rgba(118, 75, 162, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)'
            ];
            
            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(item => item.endpoint),
                    datasets: [{
                        data: data.map(item => item.requests),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function updateTables(data) {
            // Update top users table
            const usersTableBody = document.querySelector('#usersTable tbody');
            usersTableBody.innerHTML = data.top_users.map(user => `
                <tr>
                    <td>${user.user_id}</td>
                    <td>${user.requests}</td>
                    <td>${user.tokens.toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Update endpoints table
            const endpointsTableBody = document.querySelector('#endpointsTable tbody');
            endpointsTableBody.innerHTML = data.endpoint_stats.map(endpoint => `
                <tr>
                    <td>${endpoint.endpoint}</td>
                    <td>${endpoint.requests}</td>
                    <td>${Math.round(endpoint.avg_latency_ms)}</td>
                    <td>${(endpoint.error_rate * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
